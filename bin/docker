#!/bin/sh
set -ue

DOCKER_USER="root"
DOCKER_HOST="$(docker-vm ip)"
DOCKER_ROOT="/dockerhome"

escape_path() {
    # escape spaces in path
    echo "$1" | sed s'+ +\\ +g'
}

PWD=$(pwd)

DOCKER_CUR_DIR=$(escape_path "$DOCKER_ROOT$PWD")

SSH_OPTS=""
SSH_CMD="cd $DOCKER_CUR_DIR && docker"

prev_arg=""
for arg in "$@"
do
    # in case of volume mapping override local pathes
    # TODO: refine according docker docs - this won't work in all cases of mappings.
    case "$prev_arg" in
        "-v" ) arg="$DOCKER_ROOT$arg" ;;
    esac
    case "$arg" in
        # in case docker was asked to allocate a TTY, ask ssh to do it as well
        -it|-ti|-t|--tty* ) SSH_OPTS="$SSH_OPTS -tt" ;;
    esac
    prev_arg="$arg"
    SSH_CMD="$SSH_CMD \"$arg\""
done

# shellcheck disable=SC2086,SC2090
exec ssh $SSH_OPTS -o "LogLevel=QUIET" "$DOCKER_USER@$DOCKER_HOST" $SSH_CMD
